<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile ‚Ä¢ Telegram Mini WebApp</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/js/all.min.js" integrity="sha512-6BTOlkauINO65nLhXhthZMtepgJSghyimIalb+crKRPhvhmsCdnIuGcVbR5/aQY2A+260iC1OPy1oCdB6pSSwQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- =========================
       THEME & BASE STYLES
       ========================= -->
  <style>
    :root {
      /* Light Theme */
      --bg: #0b0f14;            /* Dark default */
      --bg-soft: #11161d;
      --card: #11161d;
      --text: #e9eef7;
      --text-dim: #a9b3c3;
      --primary: #27AE60;       /* User's preferred brand color */
      --primary-weak: rgba(39,174,96,0.16);
      --border: #1e2734;
      --ok: #2ecc71;
      --warn: #f39c12;
      --err: #e74c3c;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    :root.light {
      /* Light theme overrides */
      --bg: #f5f7fb;
      --bg-soft: #ffffff;
      --card: #ffffff;
      --text: #0b0f14;
      --text-dim: #4d5b72;
      --primary-weak: rgba(39,174,96,0.12);
      --border: #e6ecf5;
      --shadow: 0 10px 24px rgba(2,12,27,.06);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app {
      max-width: 980px;
      margin: 0 auto;
      padding: 10px 14px 100px; /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ ‡¶ï‡¶Æ‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶®‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá */
    }

    /* Section spacing */
    .section {
      margin-bottom: 24px;
    }

    /* Header */
    .topbar {
      position: sticky; top: 0; z-index: 50;
      background: linear-gradient(180deg, var(--bg) 70%, transparent);
      padding: 4px 0 8px; /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ ‡¶ï‡¶Æ‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶®‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá */
      display: flex; align-items: center; gap: 10px; justify-content: space-between;
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .logo {
      width: 36px; height: 36px; border-radius: 12px; display: grid; place-items: center;
      background: var(--primary-weak); color: var(--primary); font-weight: 800;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .title { font-size: 16px; font-weight: 700; letter-spacing: .2px; }

    /* Buttons */
    .btn {
      --h: 42px; --px: 14px; --rad: 12px;
      height: var(--h); padding: 0 var(--px);
      border-radius: var(--rad);
      border: 1px solid var(--border);
      background: var(--bg-soft);
      color: var(--text);
      display: inline-flex; align-items: center; gap: 10px; justify-content: center;
      font-weight: 600; cursor: pointer; user-select: none;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      box-shadow: var(--shadow);
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.primary { background: var(--primary); color: #fff; border-color: transparent; }
    .btn.ghost   { background: transparent; }
    .btn.small   { --h: 34px; --px: 10px; --rad: 10px; font-size: 13px; }
    .btn.icon { --px: 8px; }

    .theme-switch { display: inline-flex; align-items: center; gap: 8px; }

    /* Layout */
    .grid {
      display: grid; gap: 16px;
      grid-template-columns: 1.4fr 1fr;
    }
    @media (max-width: 860px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h3 { margin: 0 0 12px; font-size: 16px; }
    .muted { color: var(--text-dim); font-size: 13px; }

    /* Profile */
    .profile {
      display: grid; grid-template-columns: 92px 1fr; gap: 16px; align-items: center;
    }
    .avatar {
      width: 92px; height: 92px; border-radius: 22px; overflow: hidden; border: 1px solid var(--border);
      background: #0a0a0a; display: grid; place-items: center; font-weight: 800; color: #7b8aa2;
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .kv { 
      display: grid; 
      grid-template-columns: 1fr auto; 
      gap: 8px; 
      align-items: center; 
      padding: 8px 0; 
    }
    .kv .k { color: var(--text-dim); font-size: 13px; }
    .kbd { 
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
      letter-spacing: .2px; 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    /* Stat cards */
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    @media (max-width: 680px){ .stats { grid-template-columns: repeat(2, 1fr);} }
    .stat { padding: 14px; border-radius: 16px; border: 1px solid var(--border); background: linear-gradient(180deg, var(--bg-soft), transparent); }
    .stat .label { color: var(--text-dim); font-size: 12px; }
    .stat .value { font-weight: 800; font-size: 20px; margin-top: 6px; }

    /* Table */
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { text-align: left; padding: 10px 8px; border-bottom: 1px dashed var(--border); }
    .table th { color: var(--text-dim); font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: .6px; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); font-size: 12px; }
    .badge.success { background: rgba(46, 204, 113, 0.15); color: #2ecc71; border-color: rgba(46, 204, 113, 0.3); }
    .badge.pending { background: rgba(243, 156, 18, 0.15); color: #f39c12; border-color: rgba(243, 156, 18, 0.3); }
    .badge.rejected { background: rgba(231, 76, 60, 0.15); color: #e74c3c; border-color: rgba(231, 76, 60, 0.3); }

    /* Toast */
    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%) translateY(20px);
      background: var(--bg-soft); color: var(--text);
      border: 1px solid var(--border); border-radius: 12px; padding: 10px 14px; box-shadow: var(--shadow);
      opacity: 0; pointer-events: none; transition: .25s ease;
      z-index: 100;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* Demo banner */
    .demo {
      background: var(--primary-weak);
      color: var(--primary);
      padding: 10px 14px;
      border-radius: 12px;
      margin-bottom: 16px;
      font-size: 14px;
      border: 1px solid var(--border);
    }

    /* ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ì‡¶≠‡¶æ‡¶∞‡¶´‡ßç‡¶≤‡ßã ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ - ‡¶®‡¶æ‡¶Æ, ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
    .text-truncate {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }
    
  </style>
</head>
<body>
  <div class="app">
    <!-- Topbar -->
    <div class="topbar">
      <div class="theme-switch">
        <button id="themeToggle" class="btn small ghost" title="‡¶•‡¶ø‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®"> <i class="fa-solid fa-moon"></i> Theme</button>
        <button id="languageToggle" class="btn small ghost" title="Change language"> <i class="fa-solid fa-language"></i> <span id="languageText">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</span></button>
      </div>
    </div>
    
    <!-- Demo note (hides when inside Telegram) -->
    <div id="demoBanner" class="demo" style="display:none;">
      Demo Mode ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡•§ Telegram ‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø mock user ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§
    </div>

    <!-- Profile Card -->
    <div class="section">
      <div class="card" id="profileCard">
        <div class="profile">
          <div class="avatar" id="avatar"><span>üë§</span></div>
          <div>
            <div class="kv">
              <div class="k" data-i18n="name">Name:</div>
              <div class="copy">
                <span id="fullName" class="kbd text-truncate skeleton" style="min-width:160px; height:16px; border-radius:6px;"></span>
              </div>
            </div>
            <div class="kv">
              <div class="k" data-i18n="username">TgUN:</div>
              <div class="copy">
                <span id="username" class="kbd text-truncate skeleton" style="min-width:140px; height:16px; border-radius:6px;"></span>
                <button class="btn icon small" data-copy="username" title="Copy"> <i class="fa-solid fa-copy"></i> </button>
              </div>
            </div>
            <div class="kv">
              <div class="k" data-i18n="userid">UID:</div>
              <div class="copy">
                <span id="chatId" class="kbd text-truncate skeleton" style="min-width:140px; height:16px; border-radius:6px;"></span>
                <button class="btn icon small" data-copy="chatId" title="Copy"> <i class="fa-solid fa-copy"> </i></button>
              </div>
            </div>
            <div class="kv">
              <div class="k" data-i18n="joindate">Date:</div>
              <div class="copy">
                <span id="joinDate" class="kbd text-truncate skeleton" style="min-width:120px; height:16px; border-radius:6px;"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Card -->
    <div class="section">
      <div class="card">
        <h3 data-i18n="accountOverview">Account Overview</h3>
        <div class="stats">
          <div class="stat">
            <div class="label" data-i18n="balance">Balance</div>
            <div id="balance" class="value">0.00</div>
          </div>
          <div class="stat">
            <div class="label" data-i18n="todayEarning">Today Earning</div>
            <div id="todayEarning" class="value">0.00</div>
          </div>
          <div class="stat">
            <div class="label" data-i18n="totalWithdraw">Total Withdraw</div>
            <div id="totalWithdraw" class="value">0.00</div>
          </div>
          <div class="stat">
            <div class="label" data-i18n="totalEarning">Total Earning</div>
            <div id="totalEarning" class="value">0.00</div>
          </div>
        </div>
      </div>
    </div>

    <!-- History Card -->
    <div class="section">
      <div class="card">
        <h3 data-i18n="withdrawHistory">‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø</h3>
        <table class="table" id="historyTable">
          <thead>
            <tr>
              <th data-i18n="date">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
              <th data-i18n="method">‡¶Æ‡ßá‡¶•‡¶°</th>
              <th data-i18n="amount">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
              <th data-i18n="status">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="4" class="muted" data-i18n="loading">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
  
  <div id="toast" class="toast">‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!</div>
  
  <!-- =========================
       TELEGRAM + FIREBASE LOGIC
       ========================= -->
  <script>
    // ------------------------------
    // Language and Theme persistence
    // ------------------------------
    const root = document.documentElement;
    const THEME_KEY = 'oc_theme';
    const LANG_KEY = 'oc_language';
    
    // Language translations
    const translations = {
      'bn': {
        'name': '‡¶®‡¶æ‡¶Æ:',
        'username': '‡¶á‡¶â‡¶è‡¶®:',
        'userid': '‡¶Ü‡¶á‡¶°‡¶ø:',
        'joindate': '‡¶ú‡¶Ø‡¶º‡ßá‡¶® ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:',
        'accountOverview': '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™',
        'balance': '‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏',
        'todayEarning': '‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Ü‡¶Ø‡¶º',
        'totalWithdraw': '‡¶Æ‡ßã‡¶ü ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®',
        'totalEarning': '‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º',
        'withdrawHistory': '‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø',
        'date': '‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ',
        'method': '‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø',
        'amount': '‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£',
        'status': '‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏',
        'loading': '‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶',
        'noHistory': '‡¶ï‡ßã‡¶®‡ßã ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø',
        'copySuccess': '‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
        'copyFailed': '‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
        'themeChange': '‡¶•‡¶ø‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
        'languageChange': '‡¶≠‡¶æ‡¶∑‡¶æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
        'success': '‡¶∏‡¶´‡¶≤',
        'pending': '‡¶Æ‡ßÅ‡¶≤‡¶§‡ßÅ‡¶¨‡¶ø',
        'rejected': '‡¶¨‡¶æ‡¶§‡¶ø‡¶≤',
        'dataLoadError': '‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá'
      },
      'en': {
        'name': 'Name:',
        'username': 'Username:',
        'userid': 'User ID:',
        'joindate': 'Bot Join Date:',
        'accountOverview': 'Account Overview',
        'balance': 'Balance',
        'todayEarning': 'Today Earning',
        'totalWithdraw': 'Total Withdraw',
        'totalEarning': 'Total Earning',
        'withdrawHistory': 'Withdraw History',
        'date': 'Date',
        'method': 'Method',
        'amount': 'Amount',
        'status': 'Status',
        'loading': 'Loading‚Ä¶',
        'noHistory': 'No history found',
        'copySuccess': 'Copied successfully',
        'copyFailed': 'Failed to copy',
        'themeChange': 'Change theme',
        'languageChange': 'Change language',
        'success': 'Success',
        'pending': 'Pending',
        'rejected': 'Rejected',
        'dataLoadError': 'Failed to load data'
      }
    };
    
    // Apply language
    function applyLanguage(lang) {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
          el.textContent = translations[lang][key];
        }
      });
      document.getElementById('languageText').textContent = lang === 'bn' ? 'English' : '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ';
      document.getElementById('languageToggle').setAttribute('title', lang === 'bn' ? 'Change to English' : '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶Ø‡¶º ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
      localStorage.setItem(LANG_KEY, lang);
      
      // Firebase-‡¶è ‡¶≠‡¶æ‡¶∑‡¶æ ‡¶™‡ßç‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó ‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶•‡¶æ‡¶ï‡ßá)
      if (window.currentUserRef) {
        updateUserPreference({ language: lang });
      }
    }
    
    // Apply theme
    function applyTheme(t){
      const themeIcon = document.querySelector('#themeToggle i');
      if (t === 'light') {
        root.classList.add('light');
        themeIcon.className = 'fa-solid fa-sun';
      } else {
        root.classList.remove('light');
        themeIcon.className = 'fa-solid fa-moon';
      }
      localStorage.setItem(THEME_KEY, t);
      try { if (window.Telegram?.WebApp?.setHeaderColor) window.Telegram.WebApp.setHeaderColor(t === 'light' ? '#ffffff' : '#0b0f14'); } catch {}
      
      // Firebase-‡¶è ‡¶•‡¶ø‡¶Æ ‡¶™‡ßç‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó ‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶•‡¶æ‡¶ï‡ßá)
      if (window.currentUserRef) {
        updateUserPreference({ theme: t });
      }
    }
    
    // Initialize theme and language
    const savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
    const savedLang = localStorage.getItem(LANG_KEY) || 'bn';
    applyTheme(savedTheme);
    applyLanguage(savedLang);
    
    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      applyTheme(root.classList.contains('light') ? 'dark' : 'light');
    });
    
    // Language toggle
    document.getElementById('languageToggle').addEventListener('click', ()=>{
      const currentLang = localStorage.getItem(LANG_KEY) || 'bn';
      applyLanguage(currentLang === 'bn' ? 'en' : 'bn');
    });

    // ------------------------------
    // Helpers
    // ------------------------------
    const $ = (id) => document.getElementById(id);
    const toast = (msg='‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!') => { 
      const el=$('toast'); 
      el.textContent=msg; 
      el.classList.add('show'); 
      setTimeout(()=>el.classList.remove('show'), 1200); 
    };
    const fmtMoney = (n) => (typeof n === 'number' ? n : Number(n||0)).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    // Copy buttons
    document.querySelectorAll('[data-copy]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-copy');
        const text = $(id)?.dataset?.value || $(id)?.textContent?.trim();
        const currentLang = localStorage.getItem(LANG_KEY) || 'bn';
        try { 
          await navigator.clipboard.writeText(text); 
          toast(translations[currentLang]['copySuccess'] + ': ' + text); 
        } catch { 
          toast(translations[currentLang]['copyFailed']); 
        }
      });
    });

    // ------------------------------
    // Telegram user (real or mock for local testing)
    // ------------------------------
    function getTelegramUser(){
      // Telegram WebApp initialization with safety check
      if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
        try {
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
          if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
            return { source: 'telegram', user: Telegram.WebApp.initDataUnsafe.user };
          }
        } catch (error) {
          console.log('Telegram WebApp initialization error:', error);
        }
      }
      
      // Mock (for local dev)
      const mock = {
        id: 999999999,
        first_name: 'Your',
        last_name: 'Name',
        username: '' ,
        language_code: 'bn',
        is_premium: true,
        photo_url: ''
      };
      return { source: 'mock', user: mock };
    }

    // Render profile skeleton to real content
    function renderProfile(u, joinedAt){
      if (!u) return;
      
      const fullName = [u.first_name, u.last_name].filter(Boolean).join(' ') || '-';
      const uname = u.username ? '@'+u.username : '-';
      const id = String(u.id);

      const pic = u.photo_url;
      const avatar = $('avatar');
      if (pic) {
        avatar.innerHTML = `<img alt="avatar" src="${pic}">`;
      } else {
        avatar.innerHTML = '<span>üë§</span>';
      }

      const setText = (el, text) => { 
        el.classList.remove('skeleton'); 
        el.textContent = text; 
        el.dataset.value = text; 
      };
      
      setText($('fullName'), fullName);
      setText($('username'), uname);
      setText($('chatId'), id);
      setText($('joinDate'), joinedAt ? new Date(joinedAt).toLocaleDateString() : new Date().toLocaleDateString());
    }

    function renderStats(stats){
      const setV = (id, v) => { 
        const el = $(id); 
        el.textContent = fmtMoney(v); 
      };
      setV('balance', stats.balance || 0);
      setV('todayEarning', stats.todayEarning || 0);
      setV('totalWithdraw', stats.totalWithdraw || 0);
      setV('totalEarning', stats.totalEarning || 0);
    }

    function renderHistory(rows){
      const tbody = document.querySelector('#historyTable tbody');
      const currentLang = localStorage.getItem(LANG_KEY) || 'bn';
      tbody.innerHTML = '';
      
      if (!rows || !rows.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" class="muted">${translations[currentLang]['noHistory']}</td>`;
        tbody.appendChild(tr);
        return;
      }
      
      rows.forEach(r => {
        const tr = document.createElement('tr');
        const date = r.createdAt ? new Date(r.createdAt).toLocaleString() : '-';
        const method = r.method || '-';
        const amt = fmtMoney(r.amount || 0);
        const status = r.status || 'pending';
        const statusText = translations[currentLang][status] || status;
        
        tr.innerHTML = `
          <td>${date}</td>
          <td>${method}</td>
          <td>${amt}</td>
          <td><span class="badge ${status}">${statusText}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }
  </script>
  
  <!-- =========================
       FIREBASE (v9 Modular via CDN)
       Fill your config below
       ========================= -->
  <script type="module">
    // ===== IMPORTANT: Add your Firebase project config here =====
    // üîß Replace the placeholders with your real values from Firebase Console
    const firebaseConfig = {
      apiKey: "AIzaSyCs6ePkTxvMjcERh6yAdvjPqxIu6X7jhRM",
      authDomain: "fbm-market-bot.firebaseapp.com",
      projectId: "fbm-market-bot",
      storageBucket: "fbm-market-bot.firebasestorage.app",
      messagingSenderId: "711610016805",
      appId: "1:711610016805:web:c5a019c9af1485ac984bcc",
      databaseURL: "https://fbm-market-bot-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    // ===== Imports =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, query, orderBy, limit, getDocs, onSnapshot, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    // ===== App Init =====
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== Telegram user (real or mock) =====
    const { source, user } = getTelegramUser();
    const demoBanner = document.getElementById('demoBanner');
    if (source === 'mock') demoBanner.style.display = 'block';

    // ===== Step 1: First render Telegram user data =====
    renderProfile(user, Date.now());

    // ===== Firebase-‡¶è ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® =====
    async function updateUserPreference(prefs) {
      try {
        if (!window.currentUserRef) return;
        
        await updateDoc(window.currentUserRef, {
          ...prefs,
          updatedAt: serverTimestamp()
        });
      } catch (error) {
        console.error('‡¶™‡ßç‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:', error);
      }
    }

    // ===== Step 2: Then load user data from Firebase using chat ID =====
    async function loadUserDataFromFirebase(){
      if (!user || !user.id) {
        console.error('User data not available');
        const currentLang = localStorage.getItem(LANG_KEY) || 'bn';
        toast(translations[currentLang]['dataLoadError'] || '‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
        return;
      }
      
      const uid = String(user.id);
      const uRef = doc(db, 'users', uid);
      window.currentUserRef = uRef; // ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£
      
      const snap = await getDoc(uRef);

      let joinedAt = Date.now();
      let initialJoinDate = null;

      if (!snap.exists()) {
        // Create new user with defaults
        const payload = {
          id: uid,
          first_name: user.first_name || '',
          last_name: user.last_name || '',
          username: user.username || '',
          photo_url: user.photo_url || '',
          is_premium: !!user.is_premium,
          language_code: user.language_code || 'en',
          balance: 0,
          todayEarning: 0,
          totalWithdraw: 0,
          totalEarning: 0,
          joinDate: serverTimestamp(),
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          // ‡¶™‡ßç‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£
          preferences: {
            theme: localStorage.getItem(THEME_KEY) || 'dark',
            language: localStorage.getItem(LANG_KEY) || 'bn'
          }
        };
        await setDoc(uRef, payload);
        
        // Render with new user data
        renderProfile(user, joinedAt);
        renderStats({
          balance: 0,
          todayEarning: 0,
          totalWithdraw: 0,
          totalEarning: 0,
        });
        
        initialJoinDate = joinedAt;
      } else {
        const data = snap.data();
        initialJoinDate = (data.joinDate?.toDate?.() ? data.joinDate.toDate().getTime() : (data.joinDate || Date.now()));
        joinedAt = initialJoinDate; // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£
        
        // Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
        if (data.preferences) {
          if (data.preferences.theme) {
            applyTheme(data.preferences.theme);
          }
          if (data.preferences.language) {
            applyLanguage(data.preferences.language);
          }
        }
        
        // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶≤‡ßá Firebase-‡¶è ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
        const needsUpdate = 
          (data.first_name !== user.first_name) ||
          (data.last_name !== user.last_name) ||
          (data.username !== user.username) ||
          (data.photo_url !== user.photo_url);
        
        if (needsUpdate) {
          await updateDoc(uRef, {
            first_name: user.first_name || '',
            last_name: user.last_name || '',
            username: user.username || '',
            photo_url: user.photo_url || '',
            updatedAt: serverTimestamp()
          });
        }
        
        // Update profile with data from Firebase
        renderProfile({
          id: data.id || user.id,
          first_name: data.first_name || user.first_name,
          last_name: data.last_name || user.last_name,
          username: data.username || user.username,
          photo_url: data.photo_url || user.photo_url
        }, initialJoinDate); // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
        
        // Render stats from Firebase
        renderStats({
          balance: data.balance || 0,
          todayEarning: data.todayEarning || 0,
          totalWithdraw: data.totalWithdraw || 0,
          totalEarning: data.totalEarning || 0,
        });

        // Load withdraw history
        const hRef = collection(uRef, 'withdraws');
        const q = query(hRef, orderBy('createdAt','desc'), limit(20));
        const hSnap = await getDocs(q);
        const rows = [];
        hSnap.forEach(d=>{
          const x = d.data();
          rows.push({
            amount: x.amount || 0,
            method: x.method || '-',
            status: x.status || 'pending',
            createdAt: x.createdAt?.toDate?.() ? x.createdAt.toDate().getTime() : (x.createdAt || null)
          });
        });
        renderHistory(rows);

        // Set up real-time listeners for updates
        onSnapshot(uRef, (doc) => {
          if (doc.exists()) {
            const data = doc.data();
            renderStats({
              balance: data.balance || 0,
              todayEarning: data.todayEarning || 0,
              totalWithdraw: data.totalWithdraw || 0,
              totalEarning: data.totalEarning || 0,
            });
            
            // ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶≤‡ßá UI-‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶´‡¶≤‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
            renderProfile({
              id: data.id || user.id,
              first_name: data.first_name || user.first_name,
              last_name: data.last_name || user.last_name,
              username: data.username || user.username,
              photo_url: data.photo_url || user.photo_url
            }, initialJoinDate); // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®
          }
        });

        onSnapshot(q, (querySnapshot) => {
          const rows = [];
          querySnapshot.forEach((doc) => {
            const x = doc.data();
            rows.push({
              amount: x.amount || 0,
              method: x.method || '-',
              status: x.status || 'pending',
              createdAt: x.createdAt?.toDate?.() ? x.createdAt.toDate().getTime() : (x.createdAt || null)
            });
          });
          renderHistory(rows);
        });
      }
    }

    // Load data from Firebase
    loadUserDataFromFirebase().catch(err=>{
      console.error('Firebase error:', err);
      const currentLang = localStorage.getItem(LANG_KEY) || 'bn';
      toast(translations[currentLang]['dataLoadError'] || '‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
      
      // Hide skeleton loaders on error
      document.querySelectorAll('.skeleton').forEach(el => {
        el.classList.remove('skeleton');
        el.textContent = '-';
      });
    });
  </script>
  
  <!-- Telegram WebApp JS (optional, loaded by Telegram client automatically). Safe to include for local preview. -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
